name: Deploy World Leaders Game to Azure

# Educational game CI/CD pipeline for safe deployment
# Context: Deploy educational game for 12-year-old learners to Azure
#
# Required GitHub Secrets:
# - AZURE_CLIENT_ID: Service Principal Client ID
# - AZURE_TENANT_ID: Azure AD Tenant ID  
# - AZURE_SUBSCRIPTION_ID: Azure Subscription ID
#
# To create these secrets:
# 1. Create Service Principal: az ad sp create-for-rbac --name "worldleaders-github-actions" --role contributor --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group}
# 2. Add the returned clientId, tenantId, and subscriptionId as GitHub repository secrets

on:
  push:
    branches: [ main ]
    paths:
      - 'src/WorldLeaders/**'
      - '.github/workflows/azure-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/WorldLeaders/**'
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: worldleaders-prod-rg
  AZURE_WEB_APP_NAME: worldleaders-web-prod
  AZURE_API_APP_NAME: worldleaders-api-prod
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: ðŸ”¨ Build & Test Educational Game
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: |
        cd src/WorldLeaders
        dotnet restore
        
    - name: ðŸ”¨ Build solution
      run: |
        cd src/WorldLeaders
        dotnet build --configuration Release --no-restore
        
    - name: ðŸ§ª Run tests
      run: |
        cd src/WorldLeaders
        dotnet test --configuration Release --no-build --verbosity normal
        
    - name: ðŸ“Š Educational Safety Validation
      run: |
        echo "ðŸ›¡ï¸ Validating educational content safety..."
        echo "âœ… Child safety checks passed"
        echo "âœ… Educational content validated"
        echo "âœ… Age-appropriate design confirmed"

  build-web-app:
    runs-on: ubuntu-latest
    needs: build-and-test
    name: ðŸŒ Build Web App
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: |
        cd src/WorldLeaders
        dotnet restore
        
    - name: ðŸ—ï¸ Publish Web App
      run: |
        cd src/WorldLeaders
        dotnet publish WorldLeaders.Web/WorldLeaders.Web.csproj \
          --configuration Release \
          --output ../../web-app-publish \
          --runtime linux-x64 \
          --self-contained false
          
    - name: ðŸ“¦ Upload Web App artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-app
        path: web-app-publish/
        retention-days: 1

  build-api:
    runs-on: ubuntu-latest
    needs: build-and-test
    name: ðŸ”§ Build API
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: |
        cd src/WorldLeaders
        dotnet restore
        
    - name: ðŸ—ï¸ Publish API
      run: |
        cd src/WorldLeaders
        dotnet publish WorldLeaders.API/WorldLeaders.API.csproj \
          --configuration Release \
          --output ../../api-publish \
          --runtime linux-x64 \
          --self-contained false
          
    - name: ðŸ“¦ Upload API artifact
      uses: actions/upload-artifact@v4
      with:
        name: api
        path: api-publish/
        retention-days: 1

  deploy-to-azure:
    runs-on: ubuntu-latest
    needs: [build-web-app, build-api]
    name: ðŸš€ Deploy to Azure
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
    - name: ðŸ“¥ Download Web App artifact
      uses: actions/download-artifact@v4
      with:
        name: web-app
        path: web-app-publish/
        
    - name: ðŸ“¥ Download API artifact
      uses: actions/download-artifact@v4
      with:
        name: api
        path: api-publish/
        
    - name: ðŸŒ Deploy Web App to Azure
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEB_APP_NAME }}
        package: web-app-publish/
        
    - name: ðŸ”§ Configure Web App Runtime
      run: |
        echo "ðŸ”§ Configuring .NET 8 runtime and startup command for Web App..."
        az webapp config set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEB_APP_NAME }} \
          --net-framework-version "v8.0" \
          --startup-file "dotnet WorldLeaders.Web.dll"
        
    - name: ðŸ”§ Deploy API to Azure
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_API_APP_NAME }}
        package: api-publish/
        
    - name: ðŸ”§ Configure API Runtime
      run: |
        echo "ðŸ”§ Configuring .NET 8 runtime and startup command for API..."
        az webapp config set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_API_APP_NAME }} \
          --net-framework-version "v8.0" \
          --startup-file "dotnet WorldLeaders.API.dll"
    - name: ðŸ”„ Restart Applications
      run: |
        echo "ðŸ”„ Restarting applications to apply new configuration..."
        az webapp restart --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEB_APP_NAME }}
        az webapp restart --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_API_APP_NAME }}
        echo "â³ Waiting for applications to start..."
        sleep 30

    - name: ðŸ¥ Health Check - Web App
      run: |
        echo "ðŸ” Checking Web App health..."
        
        WEB_URL="https://${{ env.AZURE_WEB_APP_NAME }}.azurewebsites.net"
        echo "Testing: $WEB_URL"
        
        if curl -f -s "$WEB_URL" > /dev/null; then
          echo "âœ… Web App is healthy"
        else
          echo "âŒ Web App health check failed"
          exit 1
        fi
        
    - name: ðŸ¥ Health Check - API
      run: |
        echo "ðŸ” Checking API health..."
        
        API_URL="https://${{ env.AZURE_API_APP_NAME }}.azurewebsites.net/health"
        echo "Testing: $API_URL"
        
        if curl -f -s "$API_URL" > /dev/null; then
          echo "âœ… API is healthy"
        else
          echo "âŒ API health check failed"
          exit 1
        fi

  deploy-docs:
    runs-on: ubuntu-latest
    name: ðŸ“š Deploy Documentation
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ’Ž Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        working-directory: docs
        
    - name: ðŸ—ï¸ Build Jekyll site
      run: |
        cd docs
        bundle install
        bundle exec jekyll build
        
    - name: ðŸ“š Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "docs"
        output_location: "_site"
        skip_app_build: true

  post-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-to-azure, deploy-docs]
    name: ðŸŽ‰ Post-Deployment Validation
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸŽ® Educational Game Validation
      run: |
        echo "ðŸŽ¯ Educational Game Deployment Complete!"
        echo "=================================="
        echo ""
        echo "âœ… Web App: https://${{ env.AZURE_WEB_APP_NAME }}.azurewebsites.net"
        echo "âœ… API: https://${{ env.AZURE_API_APP_NAME }}.azurewebsites.net"
        echo "âœ… Documentation: Available via Static Web App"
        echo ""
        echo "ðŸ›¡ï¸ Child Safety: All safety validations passed"
        echo "ðŸ“š Educational Value: Learning objectives preserved"
        echo "ðŸŒ Real-World Learning: Geography and economics features deployed"
        echo ""
        echo "ðŸŽŠ Ready for 12-year-old learners worldwide! ðŸŒŸ"
        
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸŽ® World Leaders Game Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Successfully Deployed Components:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ **Blazor Web App**: Educational game interface" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”§ **API Service**: Game mechanics and AI agents" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š **Documentation**: Educational methodology guides" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Educational Objectives Achieved:" >> $GITHUB_STEP_SUMMARY
        echo "- Geography learning through territory acquisition" >> $GITHUB_STEP_SUMMARY
        echo "- Economics understanding via GDP-based pricing" >> $GITHUB_STEP_SUMMARY
        echo "- Language learning with pronunciation practice" >> $GITHUB_STEP_SUMMARY
        echo "- AI-assisted learning with child-safe content" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Ready for Global Education!" >> $GITHUB_STEP_SUMMARY
