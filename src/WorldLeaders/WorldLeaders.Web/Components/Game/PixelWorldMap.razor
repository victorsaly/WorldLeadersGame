@*
Interactive Pixel Art World Map Component
Context: Educational geography learning for 12-year-old players with 32-bit pixel art style
Educational Objective: Visual world geography discovery through interactive map exploration
Safety Requirements: Child-friendly interactions, positive cultural representation
*@
@using WorldLeaders.Shared.Models
@using WorldLeaders.Shared.DTOs
@using WorldLeaders.Shared.Enums
@using Microsoft.AspNetCore.Components.Web
@inject IJSRuntime JSRuntime
@inject ILogger<PixelWorldMap> Logger

<div class="pixel-world-map retro-container" @onresize="OnWindowResize">
    <!-- Map Header with Child-Friendly Design -->
    <div class="map-header retro-header">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center gap-3">
                <div class="retro-icon">üó∫Ô∏è</div>
                <h2 class="text-2xl font-bold retro-title">Interactive World Map</h2>
            </div>
            
            <!-- Zoom Controls -->
            <div class="zoom-controls retro-controls">
                <button @onclick="() => SetZoomLevel(ZoomLevel.World)" 
                        class="retro-button @(CurrentZoom == ZoomLevel.World ? "active" : "")"
                        title="World View">
                    üåç
                </button>
                <button @onclick="() => SetZoomLevel(ZoomLevel.Continent)" 
                        class="retro-button @(CurrentZoom == ZoomLevel.Continent ? "active" : "")"
                        title="Continent View">
                    üåé
                </button>
                <button @onclick="() => SetZoomLevel(ZoomLevel.Region)" 
                        class="retro-button @(CurrentZoom == ZoomLevel.Region ? "active" : "")"
                        title="Region View">
                    üèûÔ∏è
                </button>
                <button @onclick="() => SetZoomLevel(ZoomLevel.Country)" 
                        class="retro-button @(CurrentZoom == ZoomLevel.Country ? "active" : "")"
                        title="Country View">
                    üèõÔ∏è
                </button>
            </div>
        </div>
        
        <!-- Educational Information Bar -->
        <div class="education-bar retro-info-bar">
            <div class="flex items-center justify-center gap-6 text-sm">
                <span class="retro-badge owned">üè¥ Owned: @OwnedCount</span>
                <span class="retro-badge available">‚ú® Available: @AvailableCount</span>
                <span class="retro-badge locked">üîí Locked: @LockedCount</span>
                <span class="retro-hint">üëÜ Click countries to explore!</span>
            </div>
        </div>
    </div>

    <!-- Main Map Container -->
    <div class="map-container" @onwheel="OnMapWheel" @onwheel:preventDefault="true">
        <div class="map-viewport" style="transform: scale(@Viewport.ZoomScale) translate(@Viewport.Center.X px, @Viewport.Center.Y px)">
            
            <!-- SVG World Map -->
            <svg class="world-map-svg" 
                 viewBox="0 0 @MapWidth @MapHeight" 
                 width="@MapWidth" 
                 height="@MapHeight"
                 @onmousedown="OnMapMouseDown"
                 @onmousemove="OnMapMouseMove"
                 @onmouseup="OnMapMouseUp"
                 @ontouchstart="OnMapTouchStart"
                 @ontouchmove="OnMapTouchMove"
                 @ontouchend="OnMapTouchEnd">
                
                <!-- Background -->
                <rect width="100%" height="100%" fill="@BackgroundColor" class="map-background"/>
                
                <!-- Grid Lines for Retro Effect -->
                @if (ShowGrid)
                {
                    <defs>
                        <pattern id="retro-grid" width="32" height="32" patternUnits="userSpaceOnUse">
                            <path d="M 32 0 L 0 0 0 32" fill="none" stroke="@GridColor" stroke-width="0.5" opacity="0.3"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#retro-grid)"/>
                }
                
                <!-- Interactive Territories -->
                @foreach (var territory in InteractiveTerritories)
                {
                    <g class="territory-group @GetTerritoryStatusClass(territory.Status)" 
                       @onclick="() => OnTerritoryClick(territory)"
                       @onmouseenter="() => OnTerritoryHover(territory)"
                       @onmouseleave="OnTerritoryLeave">
                        
                        <!-- Territory Shape -->
                        @if (territory.Boundaries.UsePolygon && territory.Boundaries.PolygonPoints.Any())
                        {
                            <polygon points="@GetPolygonPoints(territory.Boundaries.PolygonPoints)"
                                     fill="@GetTerritoryColor(territory.Status)"
                                     stroke="@GetTerritoryBorderColor(territory.Status)"
                                     stroke-width="2"
                                     class="territory-shape pixel-art"
                                     data-country="@territory.CountryCode"/>
                        }
                        else
                        {
                            <!-- Simplified rectangular territories for demo -->
                            <rect x="@territory.Boundaries.TopLeft.X" 
                                  y="@territory.Boundaries.TopLeft.Y"
                                  width="@(territory.Boundaries.BottomRight.X - territory.Boundaries.TopLeft.X)"
                                  height="@(territory.Boundaries.BottomRight.Y - territory.Boundaries.TopLeft.Y)"
                                  fill="@GetTerritoryColor(territory.Status)"
                                  stroke="@GetTerritoryBorderColor(territory.Status)"
                                  stroke-width="2"
                                  class="territory-shape pixel-art"
                                  data-country="@territory.CountryCode"/>
                        }
                        
                        <!-- Touch Zone for Mobile -->
                        <circle cx="@territory.Position.X" 
                                cy="@territory.Position.Y" 
                                r="@territory.TouchRadius"
                                fill="transparent"
                                class="touch-zone"
                                style="pointer-events: all;"/>
                        
                        <!-- Country Label -->
                        <text x="@territory.Position.X" 
                              y="@(territory.Position.Y + 5)"
                              text-anchor="middle"
                              class="territory-label retro-text"
                              fill="@GetLabelColor(territory.Status)">
                            @territory.CountryName
                        </text>
                        
                        <!-- Flag Icon -->
                        @if (!string.IsNullOrEmpty(territory.Flag.SpritePath))
                        {
                            <image x="@(territory.Position.X - 8)" 
                                   y="@(territory.Position.Y - 20)"
                                   width="16" 
                                   height="12"
                                   href="@territory.Flag.SpritePath"
                                   class="flag-sprite pixel-art"/>
                        }
                        
                        <!-- Landmarks -->
                        @foreach (var landmark in territory.Landmarks.Take(3))
                        {
                            <image x="@(landmark.Position.X - 12)" 
                                   y="@(landmark.Position.Y - 12)"
                                   width="24" 
                                   height="24"
                                   href="@landmark.SpritePath"
                                   class="landmark-sprite pixel-art"
                                   title="@landmark.Name"/>
                        }
                    </g>
                }
                
                <!-- Player Indicator if zoomed to country -->
                @if (CurrentZoom == ZoomLevel.Country && SelectedTerritory != null)
                {
                    <g class="player-indicator">
                        <circle cx="@SelectedTerritory.Position.X" 
                                cy="@SelectedTerritory.Position.Y" 
                                r="30" 
                                fill="none" 
                                stroke="@ThemeColor" 
                                stroke-width="3" 
                                class="pulse-animation"/>
                    </g>
                }
            </svg>
        </div>
    </div>

    <!-- Territory Information Tooltip -->
    @if (HoveredTerritory != null && !IsMobile)
    {
        <div class="territory-tooltip retro-tooltip" 
             style="left: @TooltipX px; top: @TooltipY px;">
            <div class="tooltip-header">
                <img src="https://flagcdn.com/w40/@(HoveredTerritory.CountryCode.ToLower()).png" 
                     alt="@HoveredTerritory.CountryName flag" 
                     class="tooltip-flag"/>
                <h4 class="font-bold">@HoveredTerritory.CountryName</h4>
            </div>
            <div class="tooltip-content">
                <p><strong>Capital:</strong> @HoveredTerritory.Education.Capital</p>
                <p><strong>Population:</strong> @HoveredTerritory.Education.PopulationMillions M</p>
                <p><strong>Status:</strong> @GetStatusDisplay(HoveredTerritory.Status)</p>
                @if (HoveredTerritory.Education.FunFacts.Any())
                {
                    <p class="fun-fact">üí° @HoveredTerritory.Education.FunFacts.First()</p>
                }
            </div>
        </div>
    }

    <!-- Map Legend -->
    <div class="map-legend retro-legend">
        <h4 class="font-bold mb-2">üîç Map Legend</h4>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-color owned"></div>
                <span>Your Territories</span>
            </div>
            <div class="legend-item">
                <div class="legend-color available"></div>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <div class="legend-color locked"></div>
                <span>Locked</span>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (IsLoading)
    {
        <div class="loading-overlay retro-loading">
            <div class="loading-content">
                <div class="retro-spinner"></div>
                <p class="mt-4 retro-text">Loading world map...</p>
                <p class="text-sm retro-subtext">Preparing geography adventure!</p>
            </div>
        </div>
    }
</div>

@code {
    // Component Parameters
    [Parameter] public Guid PlayerId { get; set; }
    [Parameter] public List<TerritoryDto> PlayerTerritories { get; set; } = new();
    [Parameter] public List<TerritoryDto> AvailableTerritories { get; set; } = new();
    [Parameter] public EventCallback<TerritoryDto> OnTerritorySelected { get; set; }
    [Parameter] public EventCallback<ZoomLevel> OnZoomChanged { get; set; }
    [Parameter] public bool IsMobile { get; set; } = false;

    // Map Configuration
    private const int MapWidth = 1280;
    private const int MapHeight = 640;
    private const string ThemeColor = "#2ea44f"; // Child designer's green theme
    private const string BackgroundColor = "#e6f3ff"; // Light blue ocean
    private const string GridColor = "#c0c0c0"; // Retro grid lines

    // Component State
    private List<InteractiveTerritory> InteractiveTerritories = new();
    private MapViewport Viewport = new();
    private ZoomLevel CurrentZoom = ZoomLevel.World;
    private InteractiveTerritory? HoveredTerritory;
    private InteractiveTerritory? SelectedTerritory;
    private bool IsLoading = true;
    private bool ShowGrid = true;
    private bool IsDragging = false;
    
    // Tooltip positioning
    private int TooltipX = 0;
    private int TooltipY = 0;

    // Statistics
    private int OwnedCount => InteractiveTerritories.Count(t => t.Status == TerritoryStatus.Owned);
    private int AvailableCount => InteractiveTerritories.Count(t => t.Status == TerritoryStatus.Available);
    private int LockedCount => InteractiveTerritories.Count(t => t.Status == TerritoryStatus.Locked);

    protected override async Task OnInitializedAsync()
    {
        await LoadMapData();
        await SetupInteractiveTerritories();
        IsLoading = false;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!IsLoading)
        {
            await UpdateTerritoryStatuses();
        }
    }

    private async Task LoadMapData()
    {
        try
        {
            // Initialize with sample data for demonstration
            // In production, this would load from a service
            await InitializeSampleTerritories();
            
            Logger.LogInformation("Loaded {Count} interactive territories for map", InteractiveTerritories.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading map data for player {PlayerId}", PlayerId);
        }
    }

    private async Task InitializeSampleTerritories()
    {
        // Sample territories with pixel coordinates (would be loaded from data in production)
        var sampleTerritories = new List<InteractiveTerritory>
        {
            new InteractiveTerritory
            {
                CountryCode = "US",
                CountryName = "United States",
                Position = new PixelCoordinate { X = 300, Y = 200 },
                Boundaries = new PixelBounds 
                { 
                    TopLeft = new PixelCoordinate { X = 250, Y = 180 },
                    BottomRight = new PixelCoordinate { X = 350, Y = 220 }
                },
                Status = TerritoryStatus.Available,
                Education = new EducationalInfo
                {
                    Capital = "Washington D.C.",
                    PopulationMillions = 331,
                    FunFacts = new List<string> { "Home to the world's first national parks!" }
                },
                Flag = new PixelFlag { SpritePath = "https://flagcdn.com/16x12/us.png", AltText = "US Flag" }
            },
            new InteractiveTerritory
            {
                CountryCode = "CA",
                CountryName = "Canada",
                Position = new PixelCoordinate { X = 300, Y = 150 },
                Boundaries = new PixelBounds 
                { 
                    TopLeft = new PixelCoordinate { X = 250, Y = 130 },
                    BottomRight = new PixelCoordinate { X = 350, Y = 170 }
                },
                Status = TerritoryStatus.Owned,
                Education = new EducationalInfo
                {
                    Capital = "Ottawa",
                    PopulationMillions = 38,
                    FunFacts = new List<string> { "Has two official languages: English and French!" }
                },
                Flag = new PixelFlag { SpritePath = "https://flagcdn.com/16x12/ca.png", AltText = "Canada Flag" }
            },
            new InteractiveTerritory
            {
                CountryCode = "GB",
                CountryName = "United Kingdom",
                Position = new PixelCoordinate { X = 640, Y = 180 },
                Boundaries = new PixelBounds 
                { 
                    TopLeft = new PixelCoordinate { X = 620, Y = 170 },
                    BottomRight = new PixelCoordinate { X = 660, Y = 190 }
                },
                Status = TerritoryStatus.Available,
                Education = new EducationalInfo
                {
                    Capital = "London",
                    PopulationMillions = 67,
                    FunFacts = new List<string> { "Big Ben is actually the name of the bell, not the tower!" }
                },
                Flag = new PixelFlag { SpritePath = "https://flagcdn.com/16x12/gb.png", AltText = "UK Flag" }
            },
            new InteractiveTerritory
            {
                CountryCode = "JP",
                CountryName = "Japan",
                Position = new PixelCoordinate { X = 1000, Y = 250 },
                Boundaries = new PixelBounds 
                { 
                    TopLeft = new PixelCoordinate { X = 980, Y = 230 },
                    BottomRight = new PixelCoordinate { X = 1020, Y = 270 }
                },
                Status = TerritoryStatus.Locked,
                Education = new EducationalInfo
                {
                    Capital = "Tokyo",
                    PopulationMillions = 125,
                    FunFacts = new List<string> { "Has over 6,800 islands!" }
                },
                Flag = new PixelFlag { SpritePath = "https://flagcdn.com/16x12/jp.png", AltText = "Japan Flag" }
            },
            new InteractiveTerritory
            {
                CountryCode = "AU",
                CountryName = "Australia",
                Position = new PixelCoordinate { X = 950, Y = 450 },
                Boundaries = new PixelBounds 
                { 
                    TopLeft = new PixelCoordinate { X = 900, Y = 420 },
                    BottomRight = new PixelCoordinate { X = 1000, Y = 480 }
                },
                Status = TerritoryStatus.Available,
                Education = new EducationalInfo
                {
                    Capital = "Canberra",
                    PopulationMillions = 26,
                    FunFacts = new List<string> { "Home to unique animals like kangaroos and koalas!" }
                },
                Flag = new PixelFlag { SpritePath = "https://flagcdn.com/16x12/au.png", AltText = "Australia Flag" }
            }
        };

        InteractiveTerritories = sampleTerritories;
        await Task.CompletedTask;
    }

    private async Task SetupInteractiveTerritories()
    {
        await UpdateTerritoryStatuses();
    }

    private async Task UpdateTerritoryStatuses()
    {
        // Update territory statuses based on player ownership
        foreach (var territory in InteractiveTerritories)
        {
            if (PlayerTerritories.Any(t => t.CountryCode == territory.CountryCode))
            {
                territory.Status = TerritoryStatus.Owned;
            }
            else if (AvailableTerritories.Any(t => t.CountryCode == territory.CountryCode))
            {
                territory.Status = TerritoryStatus.Available;
            }
            else
            {
                territory.Status = TerritoryStatus.Locked;
            }
        }
        
        await Task.CompletedTask;
    }

    private async Task SetZoomLevel(ZoomLevel zoomLevel)
    {
        CurrentZoom = zoomLevel;
        
        // Adjust viewport scale based on zoom level
        Viewport.ZoomScale = zoomLevel switch
        {
            ZoomLevel.World => 1.0,
            ZoomLevel.Continent => 1.5,
            ZoomLevel.Region => 2.0,
            ZoomLevel.Country => 3.0,
            _ => 1.0
        };

        ShowGrid = zoomLevel >= ZoomLevel.Region;
        
        await OnZoomChanged.InvokeAsync(zoomLevel);
        StateHasChanged();
    }

    private async Task OnTerritoryClick(InteractiveTerritory territory)
    {
        try
        {
            SelectedTerritory = territory;
            
            // Find corresponding DTO and notify parent
            var territoryDto = AvailableTerritories.Concat(PlayerTerritories)
                .FirstOrDefault(t => t.CountryCode == territory.CountryCode);
            
            if (territoryDto != null)
            {
                await OnTerritorySelected.InvokeAsync(territoryDto);
            }
            
            Logger.LogInformation("Territory clicked: {CountryName} ({CountryCode})", 
                territory.CountryName, territory.CountryCode);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling territory click: {CountryCode}", territory.CountryCode);
        }
    }

    private void OnTerritoryHover(InteractiveTerritory territory)
    {
        HoveredTerritory = territory;
        // Tooltip positioning would be updated here
    }

    private void OnTerritoryLeave()
    {
        HoveredTerritory = null;
    }

    // Mouse and touch event handlers for map navigation
    private void OnMapMouseDown(MouseEventArgs e) => IsDragging = true;
    private void OnMapMouseUp(MouseEventArgs e) => IsDragging = false;
    private void OnMapMouseMove(MouseEventArgs e) { /* Handle map dragging */ }
    private void OnMapTouchStart(TouchEventArgs e) => IsDragging = true;
    private void OnMapTouchEnd(TouchEventArgs e) => IsDragging = false;
    private void OnMapTouchMove(TouchEventArgs e) { /* Handle touch dragging */ }
    private void OnMapWheel(WheelEventArgs e)
    {
        // Handle zoom with mouse wheel
        var newScale = Viewport.ZoomScale + (e.DeltaY > 0 ? -0.1 : 0.1);
        Viewport.ZoomScale = Math.Max(0.5, Math.Min(5.0, newScale));
        StateHasChanged();
    }

    private async Task OnWindowResize() => await Task.CompletedTask;

    // Helper methods for styling
    private string GetTerritoryStatusClass(TerritoryStatus status) => $"territory-{status.ToString().ToLower()}";
    
    private string GetTerritoryColor(TerritoryStatus status) => status switch
    {
        TerritoryStatus.Owned => "#86efac",      // Green
        TerritoryStatus.Available => "#bfdbfe",  // Blue
        TerritoryStatus.Locked => "#e5e7eb",     // Gray
        _ => "#f3f4f6"
    };
    
    private string GetTerritoryBorderColor(TerritoryStatus status) => status switch
    {
        TerritoryStatus.Owned => "#22c55e",      // Dark green
        TerritoryStatus.Available => "#3b82f6",  // Dark blue
        TerritoryStatus.Locked => "#9ca3af",     // Dark gray
        _ => "#d1d5db"
    };
    
    private string GetLabelColor(TerritoryStatus status) => status switch
    {
        TerritoryStatus.Owned => "#166534",      // Dark green
        TerritoryStatus.Available => "#1e40af",  // Dark blue
        TerritoryStatus.Locked => "#6b7280",     // Dark gray
        _ => "#374151"
    };
    
    private string GetStatusDisplay(TerritoryStatus status) => status switch
    {
        TerritoryStatus.Owned => "üè¥ Your Territory",
        TerritoryStatus.Available => "‚ú® Available",
        TerritoryStatus.Locked => "üîí Locked",
        _ => "‚ùì Unknown"
    };
    
    private string GetPolygonPoints(List<PixelCoordinate> points)
    {
        return string.Join(" ", points.Select(p => $"{p.X},{p.Y}"));
    }
}