@page "/register"
@layout EmptyLayout
@rendermode InteractiveServer
@using WorldLeaders.Shared.DTOs
@using WorldLeaders.Shared.Enums
@using WorldLeaders.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq
@inject IAuthenticationClientService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@*
Context: Educational game registration for 12-year-old players
Educational Objective: Safe user registration with age verification and child protection
Safety Requirements: COPPA compliance, parental consent validation, age-appropriate content
Real-World Connection: Secure identity creation for educational gaming
*@

<PageTitle>Join World Leaders Game - Safe Registration</PageTitle>

<div class="retro-game-container flex items-center justify-center p-4">
    <div class="pixel-art-card green-theme w-full max-w-md">
        
        @* Educational Header *@
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">🌍</div>
            <h1 class="retro-title text-xl mb-2">JOIN THE ADVENTURE!</h1>
            <p class="retro-subtitle mb-2">CREATE YOUR ACCOUNT</p>
            <p class="retro-body text-sm">Become a world leader</p>
            <div class="flex justify-center space-x-2 mt-3">
                <span class="text-2xl">🎮</span>
                <span class="text-2xl">📚</span>
                <span class="text-2xl">🗺️</span>
            </div>
        </div>

        @* Registration Form *@
        <EditForm Model="@registerRequest" OnValidSubmit="@HandleRegistration" FormName="RegisterForm" class="space-y-6">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-red-600 text-sm font-medium bg-red-100 p-3 rounded-lg" />
            
            @* Error Messages *@
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="pixel-art-card bg-red-100 border-red-400 text-red-700 p-4 mb-4" role="alert">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">⚠️</span>
                        <span class="retro-body font-bold">@errorMessage</span>
                    </div>
                </div>
            }

            @* Success Message *@
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="pixel-art-card bg-green-100 border-green-400 text-green-700 p-4 mb-4" role="alert">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">🎉</span>
                        <span class="retro-body font-bold">@successMessage</span>
                    </div>
                </div>
            }

            @* Username Field *@
            <div class="space-y-2">
                <label for="username" class="block retro-body font-bold">
                    🔑 Choose Your Login Username
                </label>
                <InputText id="username" 
                          @bind-Value="registerRequest.Username" 
                          class="retro-input-field"
                          placeholder="Enter your login username" 
                          maxlength="50" />
                <ValidationMessage For="@(() => registerRequest.Username)" class="text-red-600 retro-body text-sm font-bold" />
                <p class="retro-body text-gray-600 text-sm">This is for logging in (different from your leader name)</p>
            </div>

            @* Age Field *@
            <div class="space-y-2">
                <label for="age" class="block retro-body font-bold">
                    🎂 How Old Are You?
                </label>
                <InputNumber id="age" 
                            @bind-Value="registerRequest.Age" 
                            class="retro-input-field"
                            min="8" 
                            max="18" />
                <ValidationMessage For="@(() => registerRequest.Age)" class="text-red-600 retro-body text-sm font-bold" />
                <p class="retro-body text-gray-600 text-sm">Must be between 8-18 years old to play</p>
            </div>

            @* Character Name Field *@
            <div class="space-y-2">
                <label for="displayName" class="block retro-body font-bold">
                    👑 Your World Leader Name
                </label>
                <InputText id="displayName" 
                          @bind-Value="registerRequest.DisplayName" 
                          class="retro-input-field"
                          placeholder="Leader Sarah, President Alex, Prime Minister Jamie" 
                          maxlength="50" />
                <ValidationMessage For="@(() => registerRequest.DisplayName)" class="text-red-600 retro-body text-sm font-bold" />
                <p class="retro-body text-gray-600 text-sm">Your official title and name as a world leader (2-50 characters)</p>
            </div>

            @* Email Field *@
            <div class="space-y-2">
                <label for="email" class="block retro-body font-bold">
                    📧 Email Address
                </label>
                <InputText id="email" 
                          @bind-Value="registerRequest.Email" 
                          type="email"
                          class="retro-input-field"
                          placeholder="your.email@example.com" />
                <ValidationMessage For="@(() => registerRequest.Email)" class="text-red-600 retro-body text-sm font-bold" />
                <p class="retro-body text-gray-600 text-sm">We'll use this to keep your account safe</p>
            </div>

            @* Parental Email Field (required for under 13) *@
            @if (registerRequest.Age < 13)
            {
                <div class="space-y-2 pixel-art-card bg-yellow-50 border-yellow-400">
                    <label for="parentalEmail" class="block retro-body font-bold text-orange-700">
                        👨‍👩‍👧‍👦 Parent/Guardian Email (Required)
                    </label>
                    <InputText id="parentalEmail" 
                              @bind-Value="registerRequest.ParentalEmail" 
                              type="email"
                              class="retro-input-field"
                              placeholder="parent@example.com" />
                    <ValidationMessage For="@(() => registerRequest.ParentalEmail)" class="text-red-600 retro-body text-sm font-bold" />
                    <p class="retro-body text-orange-600 text-sm">
                        ⚠️ Since you're under 13, we need a parent or guardian's email address for safety
                    </p>
                </div>
            }

            @* Password Field *@
            <div class="space-y-2">
                <label for="password" class="block retro-body font-bold">
                    🔐 Create Password
                </label>
                <InputText id="password" 
                          @bind-Value="registerRequest.Password" 
                          type="password"
                          class="retro-input-field"
                          placeholder="Create a strong password" />
                <ValidationMessage For="@(() => registerRequest.Password)" class="text-red-600 retro-body text-sm font-bold" />
                <p class="retro-body text-gray-600 text-sm">Must be at least 8 characters with uppercase, lowercase, and numbers</p>
            </div>

            @* Confirm Password Field *@
            <div class="space-y-2">
                <label for="confirmPassword" class="block retro-body font-bold">
                    🔐 Confirm Password
                </label>
                <InputText id="confirmPassword" 
                          @bind-Value="registerRequest.ConfirmPassword" 
                          type="password"
                          class="retro-input-field"
                          placeholder="Type your password again" />
                <ValidationMessage For="@(() => registerRequest.ConfirmPassword)" class="text-red-600 retro-body text-sm font-bold" />
            </div>

            @* Parental Consent Notice *@
            <div class="pixel-art-card bg-blue-50 border-blue-400">
                <div class="flex items-start space-x-3">
                    <span class="text-2xl">👨‍👩‍👧‍👦</span>
                    <div>
                        <h3 class="retro-subtitle text-blue-800 mb-1">PARENT/GUARDIAN NOTICE</h3>
                        <p class="retro-body text-blue-700 text-sm mb-2">
                            This is an educational game designed for children. By registering, you confirm that a parent or guardian 
                            is aware of this account creation. We follow strict child safety guidelines.
                        </p>
                        @if (registerRequest.Age < 13)
                        {
                            <p class="retro-body text-orange-700 font-bold text-sm">
                                🔒 Additional Safety: Since you're under 13, we require a parent/guardian email for extra protection.
                            </p>
                        }
                    </div>
                </div>
            </div>

            @* Terms Agreement *@
            <div class="flex items-start space-x-3">
                <InputCheckbox id="agreeTerms" 
                              @bind-Value="agreeToTerms" 
                              class="mt-1 h-6 w-6 border-4 border-gray-400 rounded" />
                <label for="agreeTerms" class="retro-body text-sm">
                    I understand this is an educational game and agree to play respectfully and safely. 
                    A parent or guardian knows about this account.
                </label>
            </div>
            @if (showTermsError)
            {
                <p class="text-red-600 retro-body text-sm font-bold">Please confirm you understand and agree to the terms</p>
            }

            @* Register Button *@
            <button type="submit" 
                    disabled="@isLoading" 
                    class="pixel-art-button w-full retro-touch-target">
                @if (isLoading)
                {
                    <div class="flex items-center justify-center space-x-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        <span>CREATING ACCOUNT...</span>
                    </div>
                }
                else
                {
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-2xl">🚀</span>
                        <span>START MY ADVENTURE!</span>
                    </div>
                }
            </button>
        </EditForm>

        @* Login Link *@
        <div class="mt-8 text-center">
            <p class="retro-body">Already have an account?</p>
            <a href="/login" class="text-green-600 hover:text-green-800 font-bold retro-body">
                SIGN IN HERE
            </a>
        </div>

        @* Educational Footer *@
        <div class="mt-6 text-center">
            <p class="retro-body text-gray-600 text-sm">
                🎓 Learn geography, economics, and languages while having fun!
            </p>
        </div>
    </div>
</div>

<style>
    .retro-input-field {
        width: 100%;
        padding: 12px 16px;
        font-size: 14px;
        border: 4px solid var(--pixel-gray);
        background-color: white;
        font-family: 'Orbitron', 'Courier New', monospace;
        font-weight: 500;
        min-height: 48px;
        transition: all 0.3s ease;
        image-rendering: pixelated;
    }

    .retro-input-field:focus {
        border-color: var(--retro-green-main);
        outline: none;
        box-shadow: 0 0 0 4px rgba(46, 164, 79, 0.2);
    }

    .retro-input-field:disabled {
        background-color: var(--pixel-light-gray);
        border-color: var(--pixel-gray);
        opacity: 0.6;
    }
</style>

@code {
    private RegisterUserRequest registerRequest = new()
    {
        Username = "",
        Email = "",
        Password = "",
        ConfirmPassword = "",
        DisplayName = "",
        DateOfBirth = DateTime.Today.AddYears(-12), // Default to 12 years ago
        Age = 12, // Default to target age
        Role = UserRole.Student, // Set appropriate role
        HasGdprConsent = false, // Will be set when user agrees to terms
        HasParentalConsent = false, // Will be set when user agrees to terms
        ParentalEmail = null, // Optional field
        SchoolName = null // Optional field
    };

    private bool agreeToTerms = false;
    private bool showTermsError = false;
    private bool isLoading = false;
    private string errorMessage = "";
    private string successMessage = "";

    private async Task HandleRegistration()
    {
        Console.WriteLine("HandleRegistration started");
        
        errorMessage = "";
        successMessage = "";
        showTermsError = false;

        // Validate terms agreement
        if (!agreeToTerms)
        {
            showTermsError = true;
            Console.WriteLine("Terms agreement failed");
            return;
        }

        // Set consent fields based on user agreement
        registerRequest.HasGdprConsent = agreeToTerms;
        registerRequest.HasParentalConsent = agreeToTerms;

        // Child safety age validation
        if (registerRequest.Age < 8 || registerRequest.Age > 18)
        {
            errorMessage = "Age must be between 8 and 18 years old for this educational game.";
            Console.WriteLine($"Age validation failed: {registerRequest.Age}");
            return;
        }

        // Parental email validation for under 13
        if (registerRequest.Age < 13 && string.IsNullOrWhiteSpace(registerRequest.ParentalEmail))
        {
            errorMessage = "A parent or guardian's email address is required for players under 13 years old.";
            Console.WriteLine($"Parental email required for age: {registerRequest.Age}");
            return;
        }

        // Password strength validation
        if (string.IsNullOrEmpty(registerRequest.Password) || 
            !registerRequest.Password.Any(char.IsUpper) ||
            !registerRequest.Password.Any(char.IsLower) ||
            !registerRequest.Password.Any(char.IsDigit))
        {
            errorMessage = "Password must contain at least one uppercase letter, one lowercase letter, and one number.";
            return;
        }

        Console.WriteLine($"Starting registration for user: {registerRequest.Username}");
        isLoading = true;
        StateHasChanged();

        try
        {
            var response = await AuthService.RegisterAsync(registerRequest);

            if (response != null && !string.IsNullOrEmpty(response.AccessToken))
            {
                successMessage = "🎉 Welcome to World Leaders Game! Your account has been created successfully!";
                
                // Show success message briefly, then redirect
                await Task.Delay(2000);
                Navigation.NavigateTo("/login?message=Registration successful! Please log in to start your adventure.");
            }
            else
            {
                errorMessage = response == null ? "Registration failed - no response from server." : "Registration failed - invalid response from server.";
                Console.WriteLine($"Registration failed. Response: {response?.AccessToken ?? "null"}");
            }
        }
        catch (HttpRequestException httpEx)
        {
            errorMessage = "Network error. Please check your connection and try again.";
            Console.WriteLine($"Registration HTTP error: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Registration error: {ex.Message}";
            Console.WriteLine($"Registration error: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Focus on username field for better UX using safe JavaScript function
            try
            {
                await JSRuntime.InvokeVoidAsync("focusElementById", "username");
            }
            catch
            {
                // Ignore focus errors
            }
        }
    }
}
