@using WorldLeaders.Web.Services
@using WorldLeaders.Shared.DTOs
@inject IAuthenticationClientService AuthService
@inject NavigationManager Navigation
@implements IDisposable

<div class="auth-status">
    @if (isAuthenticated)
    {
        <div class="flex items-center space-x-3">
            <span class="retro-body on-green text-xs" style="color: var(--text-on-green); font-weight: bold;">
                Welcome, @currentUser?.DisplayName! ðŸ‘‹
            </span>
            <button @onclick="HandleLogout" 
                    class="pixel-art-button-small red">
                LOGOUT
            </button>
        </div>
    }
    else
    {
        <div class="flex items-center space-x-2">
            <a href="/login" class="pixel-art-button-small blue">
                LOGIN
            </a>
            <a href="/register" class="pixel-art-button-small">
                REGISTER
            </a>
        </div>
    }
</div>

@code {
    private bool isAuthenticated = false;
    private UserInfoDto? currentUser = null;
    private System.Threading.Timer? authCheckTimer;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthenticationStatus();
        
        // Check authentication status every 30 seconds
        authCheckTimer = new System.Threading.Timer(async _ => await InvokeAsync(CheckAuthenticationStatus), 
                                                   null, 
                                                   TimeSpan.FromSeconds(30), 
                                                   TimeSpan.FromSeconds(30));
    }

    private async Task CheckAuthenticationStatus()
    {
        try
        {
            isAuthenticated = await AuthService.IsAuthenticatedAsync();
            
            if (isAuthenticated)
            {
                currentUser = await AuthService.GetCurrentUserAsync();
            }
            else
            {
                currentUser = null;
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Auth status check failed: {ex.Message}");
            isAuthenticated = false;
            currentUser = null;
            StateHasChanged();
        }
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthService.LogoutAsync();
            isAuthenticated = false;
            currentUser = null;
            StateHasChanged();
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout failed: {ex.Message}");
        }
    }

    public void Dispose()
    {
        authCheckTimer?.Dispose();
    }
}
